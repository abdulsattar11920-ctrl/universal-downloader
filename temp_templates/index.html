<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Universal Downloader</title>

    <link rel="icon" type="image/png" href="/static/iflogo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/style.css" />
</head>

<body>

    <!-- HEADER -->
    <header class="topbar">
        <div class="brand">
            <img src="/static/logo.png" class="logo" alt="Universal Downloader Logo">
        </div>
    </header>

    <main class="container">

        <!-- INPUT -->
        <section class="card">
            <label class="label">Paste video link</label>
            <input id="url" type="text" placeholder="YouTube, TikTok, Instagram, Pinterest‚Ä¶" />
            <button class="primary" onclick="fetchPreview()">Fetch Video</button>
        </section>

        <!-- STATUS -->
        <section class="card status">
            <h3>Status</h3>
            <div id="statusLog">
                <div class="log">üü¢ Ready</div>
            </div>
        </section>

        <!-- PROGRESS BAR (NEW ‚Äì REAL) -->
        <section class="card">
            <div class="progress-wrap">
                <div id="progress-bar"></div>
            </div>
            <div id="progress-text" class="log">0%</div>
        </section>

        <!-- PREVIEW -->
        <section id="preview" class="card hidden">
            <div class="preview-grid">
                <img id="thumb" alt="Video Thumbnail" />
                <div class="meta">
                    <h2 id="title"></h2>
                    <p id="channel"></p>
                    <p id="duration"></p>
                </div>
            </div>

            <div class="options">
                <div>
                    <label class="label">Video Quality</label>
                    <select id="quality">
                        <option value="1080">1080p (Full HD)</option>
                        <option value="720">720p (HD)</option>
                        <option value="480">480p</option>
                    </select>
                </div>

                <label class="check">
                    <input type="checkbox" id="subs" />
                    Download subtitles (if available)
                </label>
            </div>

            <button class="success" onclick="startDownload()">Download Video</button>

            <!-- SCRIPT BUTTON (YOUTUBE ONLY) -->
            <button id="scriptBtn" class="primary" onclick="downloadScript()">
                Download Script (DOCX)
            </button>
        </section>

        <!-- DESCRIPTION -->
        <section class="card description">
            <h3>About Universal Downloader</h3>
            <p>
                Universal Downloader is a powerful, clean and easy-to-use tool designed
                to download videos from multiple platforms including YouTube, TikTok,
                Instagram, Pinterest and more.
            </p>
            <p>
                You can preview videos, choose quality, download subtitles and save
                content directly to your system without ads or unnecessary clutter.
            </p>
            <p>
                Built with performance and simplicity in mind.
            </p>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="footer no-select">
        Developed by Abdul Sattar
    </footer>

    <script>
        let progressTimer = null;

        function addLog(text) {
            const box = document.getElementById("statusLog");
            const div = document.createElement("div");
            div.className = "log";
            div.innerText = text;
            box.prepend(div);
        }

        function startProgressPolling() {
            clearInterval(progressTimer);
            progressTimer = setInterval(fetchProgress, 700);
        }

        function fetchProgress() {
            if (d.download_url) {
                addLog("‚¨áÔ∏è Download link ready");
                addLog(window.location.origin + d.download_url);
            }

            fetch("/progress")
                .then(r => r.json())
                .then(d => {
                    const bar = document.getElementById("progress-bar");
                    const text = document.getElementById("progress-text");

                    bar.style.width = d.percent + "%";
                    text.innerText = d.percent + "% - " + (d.message || "");
                    if (d.download_url) {
                        const fullLink = window.location.origin + d.download_url;
                        addLog("‚¨áÔ∏è Download video:");
                        addLog(fullLink);
                    }

                    if (d.download_url) {
                        addLog("‚¨áÔ∏è Download link ready");
                        addLog(window.location.origin + d.download_url);
                    }


                    if (d.percent >= 100) {
                        clearInterval(progressTimer);
                    }
                })
                .catch(() => { });
        }

        function fetchPreview() {
            const url = document.getElementById("url").value.trim();
            if (!url) {
                addLog("‚ùå Paste a valid link");
                return;
            }

            addLog("üîç Fetching video info‚Ä¶");

            fetch("/preview", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "url=" + encodeURIComponent(url)
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === "success") {
                        document.getElementById("thumb").src = d.thumbnail;
                        document.getElementById("title").innerText = d.title;
                        document.getElementById("channel").innerText = "Channel: " + d.uploader;
                        document.getElementById("duration").innerText =
                            "Duration: " + Math.floor(d.duration / 60) + ":" +
                            (d.duration % 60).toString().padStart(2, "0");

                        document.getElementById("preview").classList.remove("hidden");

                        const scriptBtn = document.getElementById("scriptBtn");
                        if (d.is_youtube) {
                            scriptBtn.style.display = "block";
                        } else {
                            scriptBtn.style.display = "none";
                            addLog("‚ÑπÔ∏è Script download available for YouTube only");
                        }

                        addLog("‚úÖ Video loaded");
                        startProgressPolling();
                    } else {
                        addLog("‚ùå " + d.msg);
                    }
                });
        }

        function startDownload() {
            const url = document.getElementById("url").value.trim();
            const quality = document.getElementById("quality").value;
            const subs = document.getElementById("subs").checked;

            if (!url) {
                addLog("‚ùå No URL to download");
                return;
            }

            addLog("‚¨áÔ∏è Download request sent‚Ä¶");

            fetch("/download", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body:
                    "url=" + encodeURIComponent(url) +
                    "&quality=" + encodeURIComponent(quality) +
                    "&subs=" + subs
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        addLog("‚úÖ Download started");
                        startProgressPolling();
                    } else {
                        addLog("‚ùå " + data.msg);
                    }
                });
        }

        function downloadScript() {
            const url = document.getElementById("url").value.trim();

            if (!url) {
                addLog("‚ùå No URL for script");
                return;
            }

            addLog("üìÑ Script generation started‚Ä¶");

            fetch("/script", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "url=" + encodeURIComponent(url)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        addLog("‚úÖ Script is being generated");
                        startProgressPolling();
                    } else {
                        addLog("‚ùå " + data.msg);
                    }
                });
        }
    </script>

</body>

</html>